services:
- docker
- postgresql
before_install:
- openssl aes-256-cbc -K $encrypted_d303290e7d32_key -iv $encrypted_d303290e7d32_iv
  -in keys/id_rsa_observatory_extension.key.enc -out keys/id_rsa_observatory_extension.key
  -d
- "if [ -f ${CACHE_FILE_BIGMETADATA} ]; then gunzip -c ${CACHE_FILE_BIGMETADATA} | docker load; fi"
install:
- "mkdir -p $CACHE_DIR"
- "if [ ! -f ${CACHE_FILE_BIGMETADATA} ]; then docker pull carto/bigmetadata && docker save carto/bigmetadata | gzip > ${CACHE_FILE_BIGMETADATA}; fi"
script: make $TEST_SUITE
addons:
  postgresql: '9.5'
  apt:
    packages:
    - postgresql-9.5-postgis-2.3
before_script:
- psql -U postgres -c "create extension postgis"
env:
  global:
    - CACHE_DIR=$HOME/.cache/docker
    - CACHE_FILE_BIGMETADATA=$CACHE_DIR/bigmetadata.tar.gz
  matrix:
    - TEST_SUITE=travis-etl-metadatatest
    - TEST_SUITE=travis-etl-unittest
    - TEST_SUITE=travis-diff-catalog
cache:
  directories:
    - $CACHE_DIR
deploy:
  provider: s3
  access_key_id: AKIAIFF5P3WO2RAOZTOQ
  secret_access_key:
    secure: VhFCohvt1yBObEOWG+kvQJlHGcxYp8Q/9xKju4y7Jq+7TgG1ktjnf+2UdJbxyo7eqMcAcWvaA/qYpbW+qXMiKVJL2TTs5JbbPdWvv7g/kZk5r4Bt3pmNj81fLh5jcYrYXkJZq8tWABUgFJKutZssgaOhallUtaA1q21d3YKtXocOcjI0Tk8wePzriqfiDuJVwevdn4U8EJhuogyj7IT+7izc034ybp5DmGiO1Eit29K7VrZut4qalSQnDtJaS0ktG9SskzXTrHNoivAEFXSroeyFmR4vWVIDf+vL2NReFGjy+BVgfnbHQ/aa+AaRxdKalaya/ORT9R5ngcYSGlL7ZGk5f61gDLa8x3etZU+OOIbOm4qs6OvLVh5SkAWeTxVaNwcgpF9YNg4ERI56D1hcTBDh/BTAHJ8h2Oou9Ba6K0gdO2SpaTTDIAwosTn9qkxo+8dSM3lHRSPLnKlfTeS+mch64HnkaQ0hHPq9K9VrC3DvcyaV2Trb4KgFo7O8I+Ib2c1yiBzPFMJM1/KWubGcgxdjrde0En0Ep00uL7x/P6rkBCwfr1brxo+BRF+e3cBXLbvSz42jqfa5KuA7ZCQfyrxh/2MXnHnlXjy9toR7Rs0gDMEuk+rCGLv1bT+LaTziHplkq+I0w3U1fTd7o2nNkU/lQjpUJDjd3GcGEpVWq9s=
  bucket: data-observatory-catalog
  local-dir: catalog/build/html/
  upload-dir: catalogs/$TRAVIS_BRANCH
  acl: public_read
  skip_cleanup: true
  on:
    repo: CartoDB/bigmetadata
    all_branches: true
    condition: $TEST_SUITE = travis-diff-catalog
notifications:
  slack:
    secure: bVnmsbFhjevx+BCgGp29a54TSooTnUyJhyMhc/83UUVIso/nkTqzF1g8n+15sEymK4InMLFQu3p4kLLSf8fU1dTVngGk/ouyynwqHncQCuRPbHGikb+amS3JqP0qatR6j5YcED1ZhXno3FuJtMfwaVaY549NlQp3OpnZ4bZBBd8OuHKUbtTOEsuUONojoWtB85CmEw33sfxBJs7dyFJ5OswS8tu5WrQx55+TGB9S0MxmkgV60BvocgUWdFd3kmGd47G5YHCRa9kNw8sL1oDxdh21QJ3HgzbxL/NyR4sEpM5OBXT4XVrDeOnC9j1Y90YWpWPt0wGwN8mnm8H7RJx//B64TmogfrGWwjGCSmZR7jL4Gx3VYt9GtGUaZxv2S9GeCP78Dmgd+0nJ9mEJ0vZhMMibi1ZmIp5lmkVDbJbB6Cyco26TLeuPb2Gwm8r+ucL/ngUbU07obX2EkZR2r3hCT62FNig2U/+j7TUObfZcgKgPVqSSvBSFtbaNBfzT93ee/jTqmqui+nWdBDL2thmA0Agow9w6JhbSeVCujTUIyVNs0im1+8ynqzdUxLOeCbL5vEQsJdltgrYrGGo+q782ezK/HNm7/nIlGP22csWCOu2ydKhLYY+7zsu/u+6lzsS3mkjf7Mkz7zKk+tXY4oQcFGPaiZhh2gEfGtl61NYWiNU=
    template:
      - "Build <%{build_url}|#%{build_number}> (<%{compare_url}|%{commit}>) of %{repository}@%{branch} by %{author} %{result} in %{duration}"
      - "Build catalog: https://s3.amazonaws.com/data-observatory-catalog/catalogs/%{branch}/index.html"
    on_success: always
